# 量化交易回测系统

一个基于 Streamlit 的多策略量化交易回测平台，提供直观的可视化界面和专业的回测功能。

## ✨ 主要特性

### 📊 多策略支持

- **流动性掠夺策略** (Liquidity Grab - SFP) - 捕捉假突破反转机会
- **趋势共振策略** (Trend Confluence) - VWAP + VIX 双重过滤
- **均值回归策略** (Mean Reversion - RSI) - RSI 超卖 + MA200 趋势过滤
- **每日定投策略** (Daily DCA) - 时间分散成本，降低择时风险
- **金字塔网格策略** (Pyramid Grid) ⭐ 新增 - 分层加仓 + LIFO 止盈 + 永久底仓
- **均线趋势策略** (MA200 Trend) ⭐ 新增 - 经典 200 日均线择时
- **月底效应策略** (Turn of the Month) ⭐ 新增 - 利用日历效应套利
- **波动率控制策略** (VIX Switch) ⭐ 新增 - VIX 恐慌指数择时

### 🎯 高级回测引擎

- ✅ **事件驱动回测** - 使用 Portfolio 类精确管理资金进出
- ✅ **LIFO 仓位管理** - 金字塔策略的栈式持仓追踪
- ✅ **完整指标体系** - 总收益率、夏普比率、最大回撤、胜率
- ✅ **手续费模拟** - 每笔交易 0.1% 手续费
- ✅ **基准对比** - SPY 买入持有 (Buy & Hold) 作为基准

### 📈 可视化界面

- ✅ **策略对比模式** - 一键对比所有策略表现
- ✅ **交互式图表** - Plotly 图表，支持缩放、平移
- ✅ **多维度分析** - 净值曲线、K 线图、仓位演变
- ✅ **中文界面** - 完全中文化，易于理解
- ✅ **数据刷新** - 支持强制更新历史数据

### 📚 完整文档

- ✅ **策略文档** - 每个策略都有详细的 markdown 说明文档
- ✅ **执行步骤** - 包含伪代码和参数说明
- ✅ **适用场景** - 明确每个策略的优缺点

## 🚀 快速开始

### 1. 环境要求

- Python 3.8+
- Git

### 2. 克隆项目

```bash
git clone https://github.com/cnhjp/quant-trading-system.git
cd quant-trading-system
```

### 3. 创建虚拟环境（推荐）

```bash
# Windows
python -m venv .venv
.venv\Scripts\activate

# macOS/Linux
python3 -m venv .venv
source .venv/bin/activate
```

### 4. 安装依赖

```bash
pip install -r requirements.txt
```

### 5. 运行应用

```bash
streamlit run app.py
```

应用将在浏览器中自动打开 `http://localhost:8501`

## 📁 项目结构

```
quant-trading-system/
├── app.py                      # Streamlit 主应用
├── data_loader.py              # 数据加载模块（支持本地缓存）
├── strategies.py               # 交易策略实现
├── backtester.py               # 回测引擎（含 Portfolio 类）
├── test_system.py              # 系统测试脚本
├── requirements.txt            # Python 依赖
├── .gitignore                  # Git 忽略文件
├── README.md                   # 本文件
├── docs/                       # 策略文档文件夹 ⭐ 新增
│   ├── README.md              # 策略文档索引
│   ├── 流动性掠夺策略.md
│   ├── 趋势共振策略.md
│   ├── 均值回归策略.md
│   ├── 每日定投策略.md
│   ├── 金字塔网格策略.md
│   ├── 均线趋势策略.md
│   ├── 月底效应策略.md
│   └── 波动率控制策略.md
└── data/                       # 本地数据缓存（自动生成）
    └── *.csv
```

## 💡 使用指南

### 基本操作

1. **选择标的** - 支持 SPY、QQQ 等美股 ETF
2. **设置初始资金** - 默认 $10,000，可自定义
3. **选择回测周期** - 1 年、2 年、5 年、10 年
4. **选择策略** - 单一策略或对比所有策略
5. **开始回测** - 查看结果和可视化

### 对比模式

启用"对比所有策略"复选框，系统将：

- 同时运行所有策略
- 生成对比表格（含所有关键指标）
- 绘制净值曲线对比图

### 数据更新

点击"更新数据"按钮可强制刷新历史数据（默认缓存 24 小时）

## 🎯 策略详解

### 1. 流动性掠夺策略 (Liquidity Grab - SFP)

**核心理念**: 捕捉市场假突破后的反转机会

**买入条件**:

- 看涨 SFP: 最低价 < 昨日最低价，但收盘价 > 昨日最低价
- 价格 > MA200（趋势过滤）

**卖出条件**:

- 看跌 SFP 或价格 < MA200

**适用场景**: 震荡市、区间突破

📖 [详细文档](docs/流动性掠夺策略.md)

---

### 2. 趋势共振策略 (Trend Confluence)

**核心理念**: VWAP + VIX 双重过滤，低波动趋势中入场

**买入条件**:

- 价格 > 月度锚定 VWAP
- VIX < VIX 的 20 日均线

**卖出条件**:

- 价格 < VWAP

**适用场景**: 牛市趋势、低波动期

📖 [详细文档](docs/趋势共振策略.md)

---

### 3. 均值回归策略 (Mean Reversion - RSI)

**核心理念**: RSI 超卖时买入，配合 MA200 趋势过滤

**买入条件**:

- RSI < 45（优化后阈值）
- 价格 > MA200

**卖出条件**:

- RSI > 70 或价格 < MA200

**适用场景**: 震荡上涨、趋势回调

📖 [详细文档](docs/均值回归策略.md)

---

### 4. 每日定投策略 (Daily DCA)

**核心理念**: 时间分散成本，平滑市场波动

**执行方式**:

- 将初始资金平分到每个交易日
- 每日开盘价买入固定金额
- 永不卖出

**对比基准**: 一次性投入 (Lump Sum)

**适用场景**: 长期投资、降低择时风险

📖 [详细文档](docs/每日定投策略.md)

---

### 5. 金字塔网格策略 (Pyramid Grid) ⭐ 新增

**核心理念**: 分层加仓 + LIFO 止盈 + 永久底仓

**资金分配**:

- 20% 底仓 (永久持有)
- 60% 网格子弹 (分 5 层加仓)
- 20% 备用金

**买入层级**:

- Level 0: 初始 20% 底仓
- Level 1: 跌 5% + RSI<40 → 买 10%
- Level 2: 再跌 8% → 买 15%
- Level 3: 再跌 12% → 买 15%
- Level 4: 再跌 15% → 买 20%

**止盈逻辑**:

- 上涨 5% → 卖出最近一笔的 80% (LIFO)
- 留存 20%转为底仓
- Level 0 底仓永不卖出

**适用场景**: 震荡市、深度回调后反弹

📖 [详细文档](docs/金字塔网格策略.md)

---

### 6. 均线趋势策略 (MA200 Trend) ⭐ 新增

**核心理念**: 顺势而为，牛市持有，熊市空仓

**交易逻辑**:

- 买入: 收盘价 > MA200
- 卖出: 收盘价 < MA200

**适用场景**: 长期单边趋势

📖 [详细文档](docs/均线趋势策略.md)

---

### 7. 月底效应策略 (Turn of the Month) ⭐ 新增

**核心理念**: 利用机构资金流向的日历效应

**交易逻辑**:

- 买入: 月底倒数第 4 天收盘
- 卖出: 月初第 3 天收盘
- 其余时间空仓

**适用场景**: 长期稳健投资，追求高资金利用率

📖 [详细文档](docs/月底效应策略.md)

---

### 8. 波动率控制策略 (VIX Switch) ⭐ 新增

**核心理念**: 恐慌时离场，平静时持有

**交易逻辑**:

- 持有: VIX < VIX 的 50 日均线
- 空仓: VIX > VIX 的 50 日均线

**适用场景**: 规避市场暴跌

📖 [详细文档](docs/波动率控制策略.md)

---

## 📊 回测指标说明

| 指标         | 说明                                    |
| ------------ | --------------------------------------- |
| **总收益率** | (最终净值 - 初始资金) / 初始资金        |
| **基准收益** | SPY 买入持有的收益率                    |
| **夏普比率** | 风险调整后的收益（仅金字塔策略）⭐ 新增 |
| **胜率**     | 正收益天数 / 总交易天数                 |
| **最大回撤** | 净值曲线的最大跌幅                      |

### 夏普比率 (Sharpe Ratio)

衡量每承担一单位风险所获得的超额回报：

```
夏普比率 = (平均日收益率 / 日收益标准差) × √252
```

- **> 1**: 表现良好
- **> 2**: 表现优秀
- **> 3**: 表现卓越

## 🔧 技术架构

### 核心模块

1. **DataLoader** (`data_loader.py`)

   - 从 Yahoo Finance 获取数据
   - 本地缓存（24 小时有效期）
   - 支持多个标的

2. **Strategies** (`strategies.py`)

   - 基类 `BaseStrategy`
   - 8 个具体策略实现
   - 统一的信号生成接口

3. **Backtester** (`backtester.py`)

   - 事件驱动回测引擎
   - `Portfolio` 类管理资金和持仓 ⭐ 新增
   - 完整的指标计算（含夏普比率）⭐ 新增

4. **Streamlit App** (`app.py`)
   - 完全中文化界面 ⭐ 新增
   - 交互式可视化
   - 多模式支持（单策略/对比）

### Portfolio 类 ⭐ 新增

专业的投资组合管理类，用于事件驱动回测：

**核心状态**:

- `cash`: 当前现金
- `core_positions`: 底仓列表（永久持有）
- `tradable_positions`: 可交易仓位栈（LIFO）
- `equity_history`: 净值历史
- `daily_returns`: 每日收益率

**核心方法**:

- `buy()`: 买入操作，自动扣除手续费
- `sell_lifo()`: LIFO 卖出，留存 20%转底仓
- `update_value()`: 更新净值和计算日收益率
- `get_metrics()`: 计算完整指标（含夏普比率）

## 📝 策略优化

所有策略均已优化：

### 通用优化

- ✅ **只做多** (Long Only) - 所有策略禁止做空
- ✅ **MA200 趋势过滤** - 流动性掠夺和均值回归策略
- ✅ **信号持有** - 使用 `ffill()` 持有仓位直到明确卖出

### 参数优化

- **均值回归**: RSI 买入阈值从 30 提高到 45，增加交易频率
- **金字塔网格**: 精心设计的 5 层加仓体系和 LIFO 止盈

## 🌐 部署到 Streamlit Community Cloud

### 准备工作

1. 确保代码已推送到 GitHub
2. 确保 `requirements.txt` 包含所有依赖
3. 确保项目是公开仓库（Public）

### 部署步骤

1. 访问 [share.streamlit.io](https://share.streamlit.io)
2. 使用 GitHub 账号登录
3. 点击 "New app"
4. 填写信息：
   - Repository: `cnhjp/quant-trading-system`
   - Branch: `main`
   - Main file path: `app.py`
5. 点击 "Deploy!"

几分钟后，应用即可在线访问！

## 📦 依赖说明

```
streamlit          # Web 应用框架
pandas             # 数据处理
numpy              # 数值计算
yfinance           # 金融数据获取
plotly             # 交互式图表
```

## ⚠️ 注意事项

1. **数据源**: 使用 Yahoo Finance，可能有延迟或缺失
2. **手续费**: 默认 0.1%，实际可能更高或更低
3. **滑点**: 假设按开盘价成交，实际可能有滑点
4. **仅供学习**: 本项目仅用于学习和研究，不构成投资建议

## 🔄 更新日志

### v2.0 - 2025-11-26 ⭐ 重大更新

- ✅ 新增金字塔网格、均线趋势、月底效应、波动率控制等策略
- ✅ 重构回测引擎为事件驱动模式
- ✅ 新增 Portfolio 类进行精确资金管理
- ✅ 新增夏普比率指标
- ✅ 界面完全中文化
- ✅ 创建 docs/ 文件夹，包含所有策略的详细文档
- ✅ 优化所有策略（Long Only + MA200 过滤）
- ✅ 提升代码质量和可维护性

### v1.0 - 2024-11

- ✅ 初始版本
- ✅ 4 个基础策略
- ✅ 基本回测功能
- ✅ Streamlit 界面

## 📄 许可证

MIT License - 可自由使用和修改

## 🤝 贡献

欢迎提交 Issue 和 Pull Request！

## 📧 联系方式

如有问题或建议，请通过 GitHub Issues 联系。

---

**免责声明**: 本项目仅供学习和研究使用，不构成任何投资建议。量化交易存在风险，请谨慎决策。过往表现不代表未来收益。
