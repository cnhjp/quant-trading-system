# 量化交易回测系统

一个基于 Streamlit 的多策略量化交易回测平台，提供直观的可视化界面和专业的回测功能。

## ✨ 主要特性

### 📊 多策略支持

- **流动性掠夺策略** (Liquidity Grab - SFP) - 捕捉假突破反转机会
- **趋势共振策略** (Trend Confluence) - VWAP + VIX 双重过滤
- **均值回归策略** (Mean Reversion - RSI) - RSI 超卖 + MA200 趋势过滤
- **每日定投策略** (Daily DCA) - 时间分散成本，降低择时风险
- **金字塔网格策略** (Pyramid Grid) ⭐ 新增 - 分层加仓 + LIFO 止盈 + 永久底仓
- **均线趋势策略** (MA200 Trend) ⭐ 新增 - 经典 200 日均线择时
- **月底效应策略** (Turn of the Month) ⭐ 新增 - 利用日历效应套利
- **波动率控制策略** (VIX Switch) ⭐ 新增 - VIX 恐慌指数择时

### 🎯 高级回测引擎

- ✅ **事件驱动回测** - 使用 Portfolio 类精确管理资金进出
- ✅ **LIFO 仓位管理** - 金字塔策略的栈式持仓追踪
- ✅ **完整指标体系** - 总收益率、夏普比率、最大回撤、胜率
- ✅ **手续费模拟** - 每笔交易 0.1% 手续费
- ✅ **基准对比** - SPY 买入持有 (Buy & Hold) 作为基准

### 📈 可视化界面

- ✅ **策略对比模式** - 一键对比所有策略表现
- ✅ **交易信号看板** ⭐ 新增图表 - 历史信号可视化，含价格叠加图、一致性分析、热力图
- ✅ **交互式图表** - Plotly 图表，支持缩放、平移、hover 详情
- ✅ **多维度分析** - 净值曲线、K 线图、仓位演变、信号趋势
- ✅ **中文界面** - 完全中文化，易于理解
- ✅ **数据刷新** - 支持强制更新历史数据

### 📚 完整文档

- ✅ **策略文档** - 每个策略都有详细的 markdown 说明文档
- ✅ **执行步骤** - 包含伪代码和参数说明
- ✅ **适用场景** - 明确每个策略的优缺点

## 🚀 快速开始

### 1. 环境要求

- Python 3.8+
- Git

### 2. 克隆项目

```bash
git clone https://github.com/cnhjp/quant-trading-system.git
cd quant-trading-system
```

### 3. 创建虚拟环境（推荐）

```bash
# Windows
python -m venv .venv
.venv\Scripts\activate

# macOS/Linux
python3 -m venv .venv
source .venv/bin/activate
```

### 4. 安装依赖

```bash
pip install -r requirements.txt
```

### 5. 运行应用

```bash
streamlit run app.py
```

应用将在浏览器中自动打开 `http://localhost:8501`

## 📁 项目结构

```
quant-trading-system/
├── app.py                      # Streamlit 主应用
├── config/                     # 配置模块
│   ├── settings.py             # 全局配置（标的列表）
│   ├── strategies.json         # 策略配置文件 ⭐ 新增
│   ├── tickers.json            # 标的配置文件 ⭐ 新增
│   └── ticker_loader.py        # 标的加载器 ⭐ 新增
├── core/                       # 核心逻辑模块
│   ├── auth.py                 # 用户认证模块
│   ├── data_loader.py          # 数据加载模块
│   ├── backtester.py           # 回测引擎
│   ├── strategy_loader.py      # 策略加载器 ⭐ 新增
│   └── strategies/             # 策略模块 ⭐ 重构
│       ├── __init__.py         # 策略导出
│       ├── base.py             # 基础策略类
│       ├── liquidity_grab.py   # 流动性掠夺策略
│       ├── trend_confluence.py # 趋势共振策略
│       ├── mean_reversion.py   # 均值回归策略
│       ├── daily_dca.py        # 每日定投策略
│       ├── pyramid_grid.py     # 金字塔网格策略
│       ├── ma200_trend.py      # 均线趋势策略
│       ├── turn_of_month.py    # 月底效应策略
│       └── vix_switch.py       # 波动率控制策略
├── scripts/                    # 自动化脚本模块
│   ├── update_data.py          # 数据更新脚本
│   └── notify_dingtalk.py      # 钉钉通知脚本
├── tests/                      # 测试模块
│   ├── test_system.py          # 系统测试脚本
│   └── test_refactoring.py     # 重构验证测试 ⭐ 新增
├── requirements.txt            # Python 依赖
├── .gitignore                  # Git 忽略文件
├── README.md                   # 本文件
├── .github/workflows/          # GitHub Actions 工作流
│   ├── daily_update.yml        # 数据更新配置
│   └── daily_notify.yml        # 钉钉推送配置
├── docs/                       # 文档文件夹
│   ├── 文档索引.md             # 策略文档索引
│   ├── 策略/                   # 策略文档文件夹
│   │   ├── 流动性掠夺策略.md
│   │   ├── 趋势共振策略.md
│   │   ├── 均值回归策略.md
│   │   ├── 每日定投策略.md
│   │   ├── 金字塔网格策略.md
│   │   ├── 均线趋势策略.md
│   │   ├── 月底效应策略.md
│   │   └── 波动率控制策略.md
│   ├── 策略配置示例.md         # 配置示例 ⭐ 新增
│   ├── 标的配置.md             # 标的配置说明 ⭐ 新增
│   ├── 快速开始.md             # 快速上手指南
└── data/                       # 本地数据缓存（自动生成）
    └── *.csv
```

## 💡 使用指南

### 功能模式

系统提供两种主要模式：

#### 1. 策略回测模式

**基本操作**:

1. **选择标的** - 支持 SPY、QQQ、恒生科技(3033.HK)、沪深 300(510300.SS)
2. **设置初始资金** - 默认 $10,000，可自定义
3. **选择回测周期** - 3 个月、6 个月、1 年、2 年、5 年、10 年
4. **选择策略** - 单一策略或对比所有策略
5. **查看结果** - 自动运行回测并展示可视化结果

**对比模式**:

启用"策略对比模式"复选框，系统将：

- 同时运行所有策略
- 生成对比表格（含今日操作建议、操作原因、所有关键指标）
- 绘制净值曲线对比图
- 包含基准（买入持有）作为参考

#### 2. 交易信号看板 ⭐ 新增图表功能

实时监控所有策略的当前信号，配合历史数据图表分析：

**今日操作建议**:

- 显示所有策略的最新操作建议和原因
- 使用颜色编码（绿色=买入、蓝色=持仓、红色=卖出）

**历史信号图表分析** ⭐ 新增:

1. **📈 价格与信号**

   - 双轴图表：上方显示价格走势，下方叠加所有策略信号
   - 直观展示策略信号与价格变化的时间对应关系
   - 信号强度标注：1=买入, 0.5=持仓, 0=空仓, -1=卖出

2. **📊 策略一致性**

   - 堆叠柱状图展示每日各策略发出的信号分布
   - 统计有多少策略发出买入/持仓/卖出/空仓信号
   - 评估市场共识度（多策略一致时可靠性更高）
   - 显示平均信号数统计指标

3. **🔥 信号热力图**

   - 颜色映射：绿色=买入, 蓝色=持仓, 红色=卖出, 灰色=空仓
   - 快速识别信号模式和策略差异
   - 直观查看历史信号分布

4. **📜 历史记录表**
   - 传统表格视图，显示每日每个策略的详细操作建议
   - 支持独立调整显示天数（10-365 天）

**时间范围选择**:

- 图表显示天数：10-365 天可调（默认 90 天）
- 表格显示天数：10-365 天可调（默认 30 天）

### 数据更新

点击"强制更新数据"按钮可强制刷新历史数据（默认缓存 24 小时）

## 🤖 自动化功能 (New!)

本项目利用 GitHub Actions 实现了完全免费的自动化数据更新和交易信号推送。

### 1. 自动数据更新

- **机制**: 每天北京时间 06:00 和 18:00 自动运行。
- **功能**: 从 Yahoo Finance 获取最新 5 年数据，并自动 Commit 推送到 GitHub 仓库。
- **优势**: 确保 Streamlit Cloud 部署的应用每天都能展示最新数据（因为 Streamlit Cloud 会随 GitHub 更新而自动重新部署）。
- **文件**: `.github/workflows/daily_update.yml`

### 2. 钉钉信号推送

- **机制**: 每个交易日北京时间 08:00 自动运行。
- **覆盖**: 包含所有 8 个策略（含每日定投）。
- **功能**:
  - 自动运行所有策略生成最新信号。
  - 生成 Markdown 格式的"量化交易早报"。
  - **明确指示交易数量/仓位** (e.g., "买入 100% 全仓", "买入 10% 仓位 (Level 1)")。
  - 推送到您的钉钉群机器人。
- **文件**: `.github/workflows/daily_notify.yml`

### 3. 配置指南

要启用钉钉推送，您需要在 GitHub 仓库配置 Secrets：

1. **获取钉钉 Token**:

   - 在钉钉群添加"自定义机器人"。
   - 安全设置建议选择"自定义关键词"（关键词需包含：**量化**、**交易**）。
   - 复制 Webhook 地址中的 `access_token`。

2. **配置 GitHub Secrets**:
   - 进入仓库 **Settings** -> **Secrets and variables** -> **Actions**。
   - 点击 **New repository secret**。
   - Name: `DINGTALK_ACCESS_TOKEN`
   - Value: 粘贴您的 Token。

## 🎯 策略详解

### 1. 流动性掠夺策略 (Liquidity Grab - SFP)

**核心理念**: 捕捉市场假突破后的反转机会

**买入条件**:

- 看涨 SFP: 最低价 < 昨日最低价，但收盘价 > 昨日最低价
- 价格 > MA200（趋势过滤）

**卖出条件**:

- 看跌 SFP 或价格 < MA200

**适用场景**: 震荡市、区间突破

📖 [详细文档](docs/策略/流动性掠夺策略.md)

---

### 2. 趋势共振策略 (Trend Confluence)

**核心理念**: VWAP + VIX 双重过滤，低波动趋势中入场

**买入条件**:

- 价格 > 月度锚定 VWAP
- VIX < VIX 的 20 日均线

**卖出条件**:

- 价格 < VWAP

**适用场景**: 牛市趋势、低波动期

📖 [详细文档](docs/策略/趋势共振策略.md)

---

### 3. 均值回归策略 (Mean Reversion - RSI)

**核心理念**: RSI 超卖时买入，配合 MA200 趋势过滤

**买入条件**:

- RSI < 45（优化后阈值）
- 价格 > MA200

**卖出条件**:

- RSI > 70 或价格 < MA200

**适用场景**: 震荡上涨、趋势回调

📖 [详细文档](docs/策略/均值回归策略.md)

---

### 4. 每日定投策略 (Daily DCA)

**核心理念**: 时间分散成本，平滑市场波动

**执行方式**:

- 将初始资金平分到每个交易日
- 每日开盘价买入固定金额
- 永不卖出

**对比基准**: 一次性投入 (Lump Sum)

**适用场景**: 长期投资、降低择时风险

📖 [详细文档](docs/策略/每日定投策略.md)

---

### 5. 金字塔网格策略 (Pyramid Grid) ⭐ 新增

**核心理念**: 分层加仓 + LIFO 止盈 + 永久底仓

**资金分配**:

- 20% 底仓 (永久持有)
- 60% 网格子弹 (分 5 层加仓)
- 20% 备用金

**买入层级**:

- Level 0: 初始 20% 底仓
- Level 1: 跌 5% + RSI<40 → 买 10%
- Level 2: 再跌 8% → 买 15%
- Level 3: 再跌 12% → 买 15%
- Level 4: 再跌 15% → 买 20%

**止盈逻辑**:

- 上涨 5% → 卖出最近一笔的 80% (LIFO)
- 留存 20%转为底仓
- Level 0 底仓永不卖出

**适用场景**: 震荡市、深度回调后反弹

📖 [详细文档](docs/策略/金字塔网格策略.md)

---

### 6. 均线趋势策略 (MA200 Trend) ⭐ 新增

**核心理念**: 顺势而为，牛市持有，熊市空仓

**交易逻辑**:

- 买入: 收盘价 > MA200
- 卖出: 收盘价 < MA200

**适用场景**: 长期单边趋势

📖 [详细文档](docs/策略/均线趋势策略.md)

---

### 7. 月底效应策略 (Turn of the Month) ⭐ 新增

**核心理念**: 利用机构资金流向的日历效应

**交易逻辑**:

- 买入: 月底倒数第 4 天收盘
- 卖出: 月初第 3 天收盘
- 其余时间空仓

**适用场景**: 长期稳健投资，追求高资金利用率

📖 [详细文档](docs/策略/月底效应策略.md)

---

### 8. 波动率控制策略 (VIX Switch) ⭐ 新增

**核心理念**: 恐慌时离场，平静时持有

**交易逻辑**:

- 持有: VIX < VIX 的 50 日均线
- 空仓: VIX > VIX 的 50 日均线

**适用场景**: 规避市场暴跌

📖 [详细文档](docs/策略/波动率控制策略.md)

---

## 📊 回测指标说明

| 指标         | 说明                                    |
| ------------ | --------------------------------------- |
| **总收益率** | (最终净值 - 初始资金) / 初始资金        |
| **基准收益** | SPY 买入持有的收益率                    |
| **夏普比率** | 风险调整后的收益（仅金字塔策略）⭐ 新增 |
| **胜率**     | 正收益天数 / 总交易天数                 |
| **最大回撤** | 净值曲线的最大跌幅                      |

### 夏普比率 (Sharpe Ratio)

衡量每承担一单位风险所获得的超额回报：

```
夏普比率 = (平均日收益率 / 日收益标准差) × √252
```

- **> 1**: 表现良好
- **> 2**: 表现优秀
- **> 3**: 表现卓越

## 🔧 技术架构

### 核心模块

1. **DataLoader** (`core/data_loader.py`)

   - 从 Yahoo Finance 获取数据
   - 本地缓存（24 小时有效期）
   - 支持多个标的

2. **Strategies** (`core/strategies.py`)

   - 基类 `BaseStrategy`
   - 8 个具体策略实现
   - 统一的信号生成接口

3. **Backtester** (`core/backtester.py`)

   - 事件驱动回测引擎
   - `Portfolio` 类管理资金和持仓 ⭐ 新增
   - 完整的指标计算（含夏普比率）⭐ 新增

4. **Streamlit App** (`app.py`)
   - 完全中文化界面 ⭐ 新增
   - 交互式可视化
   - 多模式支持（单策略/对比）

### Portfolio 类 ⭐ 新增

专业的投资组合管理类，用于事件驱动回测：

**核心状态**:

- `cash`: 当前现金
- `core_positions`: 底仓列表（永久持有）
- `tradable_positions`: 可交易仓位栈（LIFO）
- `equity_history`: 净值历史
- `daily_returns`: 每日收益率

**核心方法**:

- `buy()`: 买入操作，自动扣除手续费
- `sell_lifo()`: LIFO 卖出，留存 20%转底仓
- `update_value()`: 更新净值和计算日收益率
- `get_metrics()`: 计算完整指标（含夏普比率）

## 📝 策略优化

所有策略均已优化：

### 通用优化

- ✅ **只做多** (Long Only) - 所有策略禁止做空
- ✅ **MA200 趋势过滤** - 流动性掠夺和均值回归策略
- ✅ **信号持有** - 使用 `ffill()` 持有仓位直到明确卖出

### 参数优化

- **均值回归**: RSI 买入阈值从 30 提高到 45，增加交易频率
- **金字塔网格**: 精心设计的 5 层加仓体系和 LIFO 止盈

## 🌐 部署到 Streamlit Community Cloud

### 准备工作

1. 确保代码已推送到 GitHub
2. 确保 `requirements.txt` 包含所有依赖
3. 确保项目是公开仓库（Public）

### 部署步骤

1. 访问 [share.streamlit.io](https://share.streamlit.io)
2. 使用 GitHub 账号登录
3. 点击 "New app"
4. 填写信息：
   - Repository: `cnhjp/quant-trading-system`
   - Branch: `main`
   - Main file path: `app.py`
5. 点击 "Deploy!"

几分钟后，应用即可在线访问！

## 📦 依赖说明

```
streamlit          # Web 应用框架
pandas             # 数据处理
numpy              # 数值计算
yfinance           # 金融数据获取
plotly             # 交互式图表
schedule           # 任务调度
requests           # 网络请求

```

## ⚠️ 注意事项

1. **数据源**: 使用 Yahoo Finance，可能有延迟或缺失
2. **手续费**: 默认 0.1%，实际可能更高或更低
3. **滑点**: 假设按开盘价成交，实际可能有滑点
4. **仅供学习**: 本项目仅用于学习和研究，不构成投资建议

## 🔄 更新日志

### v2.5 - 2025-12-03 ⭐ 交易信号看板图表增强

- ✅ **历史信号可视化**: 为交易信号看板添加 4 个可视化标签页
  - 📈 价格与信号叠加图：双轴展示价格走势与策略信号的时间对应关系
  - 📊 策略一致性分析：堆叠柱状图统计每日信号分布，评估市场共识度
  - 🔥 信号热力图：颜色映射快速识别历史信号模式和策略差异
  - 📜 历史记录表：保留传统表格视图，支持独立调整显示天数
- ✅ **交互增强**: 支持图表和表格独立的时间范围调整（10-365 天）
- ✅ **数据优化**: 新增数值信号数据框，优化信号处理逻辑
- ✅ **视觉提升**: 专业配色方案，绿色=买入、蓝色=持仓、红色=卖出、灰色=空仓

### v2.4 - 2025-11-28 ⭐ 架构重构

- ✅ **策略模块化**: 所有策略拆分为独立文件，每个策略职责清晰
- ✅ **策略配置驱动**: 新增 `config/strategies.json`，通过配置文件控制策略可见性
- ✅ **标的配置驱动**: 新增 `config/tickers.json`，通过配置文件控制标的显示 ⭐
- ✅ **降低耦合**: 使用加载器动态加载策略和标的，`app.py` 不再硬编码
- ✅ **易于扩展**: 添加新策略/标的只需创建文件和配置，无需修改应用代码
- ✅ **测试友好**: 测试策略/标的可通过 `enabled: false` 隐藏，无需删除代码
- ✅ **Bug 修复**: 修复禁用策略时 selectbox 索引越界错误

### v2.3 - 2025-11-28 ⭐ 安全与体验升级

- ✅ **用户认证**: 新增登录界面和退出功能，保护系统访问权限
- ✅ **Bug 修复**: 修复 Streamlit 组件 Key 重复导致的报错问题

### v2.2 - 2025-11-27 ⭐ 体验优化

- ✅ **项目重构**: 采用模块化结构 (`core`, `config`, `scripts`)，提升代码可维护性
- ✅ **推送升级**: 钉钉早报覆盖全策略（新增每日定投），并明确显示具体买卖仓位/数量
- ✅ **文档更新**: 同步更新了架构图和自动化文档
- ✅ **指标修正**: 优化回测指标计算逻辑，确保数据准确性
- ✅ **UI 优化**: 自定义数据列 Tooltip 图标，提升交互体验

### v2.1 - 2025-11-27 ⭐ 自动化更新

- ✅ 新增 GitHub Actions 自动更新数据流程
- ✅ 新增 钉钉机器人每日交易信号推送
- ✅ 修复 Streamlit Cloud 数据持久化问题

### v2.0 - 2025-11-26 ⭐ 重大更新

- ✅ 新增金字塔网格、均线趋势、月底效应、波动率控制等策略
- ✅ 重构回测引擎为事件驱动模式
- ✅ 新增 Portfolio 类进行精确资金管理
- ✅ 新增夏普比率指标
- ✅ 界面完全中文化
- ✅ 创建 docs/ 文件夹，包含所有策略的详细文档
- ✅ 优化所有策略（Long Only + MA200 过滤）
- ✅ 提升代码质量和可维护性

### v1.0 - 2024-11

- ✅ 初始版本
- ✅ 4 个基础策略
- ✅ 基本回测功能
- ✅ Streamlit 界面

## 📄 许可证

MIT License - 可自由使用和修改

## 🤝 贡献

欢迎提交 Issue 和 Pull Request！

## 📧 联系方式

如有问题或建议，请通过 GitHub Issues 联系。

---

**免责声明**: 本项目仅供学习和研究使用，不构成任何投资建议。量化交易存在风险，请谨慎决策。过往表现不代表未来收益。
